var app;function getJSON(e,t){var o=new XMLHttpRequest;return new Promise((n,i)=>{if(o.onreadystatechange=()=>{4===o.readyState&&(o.status>=200&&o.status<300?n(o.response):i({status:o.status,statusText:o.statusText}))},o.onerror=()=>{i(Error("There was a network error."))},null!==(a=t.apiquery))var a="?"+Object.keys(a).map(function(e){return e+"="+encodeURIComponent(a[e])}).join("&");o.open(t.method,e+a,!0),o.responseType="json",o.send()})}(app=app||{}).init=function(){app.model=new app.Hotel,app.vm=new app.ViewModel,app.mv=new app.MapView,app.model.init(),ko.applyBindings(app.vm)},app.errorHandler=function(e){document.getElementById("map").innerHTML="There was an error loading the "+e+" script."},(app=app||{}).Hotel=function(){"use strict";var e=this;e.hotels=ko.observableArray(),e.yelp={},e.init=function(){var t=[];e.reqTimeout(),firebase.initializeApp({apiKey:"AIzaSyDAkU7fnDw-cOpyrXsRhMWCFeKbrNgvZGs",authDomain:"zeta-time-122004.firebaseapp.com",projectId:"zeta-time-122004"}),firebase.firestore().collection("hotels").get().then(function(o){o.forEach(function(o){(t=o.data()).id=o.id,t.content=null,t.review=null,t.tweets=null,e.hotels.push(t)}),app.vm.init()}).catch(function(e){var t="Error getting hotel data from Firebase: "+e;app.vm.dispMsg(t)})},e.reqTimeout=function(){setTimeout(function(){0===e.hotels().length&&(app.vm.timeout(!0),app.vm.dispMsg("Firebase server request timed out. <br> Check your connection and refresh the page."))},1e4)}},(app=app||{}).ViewModel=function(){"use strict";var e=this;e.showTicker=ko.observable(!1),e.hotelTweets=ko.observable(""),e.timeout=ko.observable(!1),e.dispMsg=ko.observable(""),e.hotelList=ko.observableArray(),e.filterList=ko.observableArray(),e.filterText=ko.observable(""),e.ratingsChecked=ko.observableArray(),e.ratings=ko.observableArray([{ratingValue:5,icon:"aaaaa",color:"red"},{ratingValue:4,icon:"aaaa",color:"yellow"},{ratingValue:3,icon:"aaa",color:"green"},{ratingValue:2,icon:"aa",color:"purple"}]),e.slideClass=ko.observable("hidden overlay"),e.showDef=ko.observable(!1),e.showName=ko.observable(!0),e.showRating=ko.observable(!1),e.showList=ko.observable(!0),e.getRatings=function(){return e.ratings()},e.nameSort=function(e,t){return e.name==t.name?0:e.name<t.name?-1:1},e.getHotels=ko.computed(function(){var t=app.model.hotels();return t.sort(e.nameSort),t}),e.getHotelsLength=ko.computed(function(){return app.model.hotels().length}),e.getKeys=function(){return app.model.yelp},e.init=function(){e.hotelList(e.getHotels()),app.mv.initMap()},e.slideIn=function(){e.slideClass("animated slideInLeft no-overlay"),e.centerPanMap()},e.slideOut=function(){e.slideClass("animated fadeOutLeft overlay"),e.centerPanMap()},e.centerPanMap=function(){google.maps.event.trigger(app.mv.map,"resize"),app.mv.currentLocation&&app.mv.map.setCenter(app.mv.currentLocation),window.screen.height>400&&window.screen.width<415&&app.mv.map.panBy(0,-120)},e.noEnter=function(e,t){return!1},e.gotoHotel=function(e){window.screen.height>400&&window.screen.width<415&&app.mv.map.panBy(0,-120),app.mv.infoWindow.close(),google.maps.event.trigger(e.marker,"click")},e.filterRatings=function(t,o){return e.hotelDisplay(),!0},e.toggleName=function(){e.showName(!e.showName())},e.toggleRating=function(){e.showRating(!e.showRating())},e.toggleList=function(){e.showList(!e.showList())},e.toggleDef=function(){e.showDef(!e.showDef())},e.hotelDisplay=ko.computed(function(){var t=-1,o=[],n=e.filterText().toLowerCase(),i=e.ratingsChecked().length,a=0,r=-1;return e.showTicker(!1),e.filterList(e.hotelList()),!n&&i<=0?(e.filterList().forEach(function(e,t){e.marker&&e.marker.setVisible(!0)}),e.filterList):(e.filterList().forEach(function(s,l){t=s.name.toLowerCase().indexOf(n),a=s.diamonds,r=i>0?e.ratingsChecked.indexOf(a):0,t>=0&&r>=0?(s.marker.setVisible(!0),o.push(s)):(s.marker.setVisible(!1),app.mv.infoWindow.close())}),e.filterList(o),e.filterList)})},(app=app||{}).MapView=function(){"use strict";var e=this;e.infoWindow=null,e.currentLocation=null,e.originalMapCenter={lat:36.1049534,lng:-115.1724043},e.mapDiv=document.getElementById("map"),e.mapOptions={disableDefaultUI:!0,center:e.originalMapCenter,zoom:15,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},e.preload='<div class="preload">Loading...<div class="spin"></div></div>',e.markerUrl="http://maps.google.com/mapfiles/ms/icons/",e.markerColors=["pink","blue","purple","green","yellow","red"],e.bounds=new google.maps.LatLngBounds,e.initMap=function(){e.map=new google.maps.Map(e.mapDiv,e.mapOptions),e.infoWindow=new google.maps.InfoWindow,e.createMarkers(),google.maps.event.addDomListener(window,"resize",function(){var t=e.map.getCenter();google.maps.event.trigger(e.map,"resize"),e.map.setCenter(t)})},e.createMarkers=function(){for(var t=0,o={},n=app.vm.getHotels(),i=app.vm.getHotelsLength();t<i;t++)(o=n[t]).color=e.markerColors[o.diamonds],o.marker=new google.maps.Marker({map:e.map,position:o.location,title:o.name,animation:null,visible:!0,icon:e.markerUrl+o.color+".png"}),e.bounds.extend(new google.maps.LatLng(o.location)),e.setInfoWin(o);e.map.fitBounds(e.bounds)},e.animateMarker=function(t){t.marker.setAnimation(google.maps.Animation.BOUNCE),t.marker.icon=e.markerUrl+t.color+"-dot.png",setTimeout(function(){t.marker.setAnimation(null),t.marker.icon=e.markerUrl+t.color+".png"},2100)},e.setInfoWin=function(t){google.maps.event.addListener(t.marker,"click",function(){e.loadContent(t),e.infoWindow.open(e.map,t.marker),e.animateMarker(t),e.currentLocation=t.location,e.map.setCenter(t.location),window.screen.height>400&&window.screen.width<415&&e.map.panBy(0,-120)})},e.loadContent=function(t){var o,n,i={hotel:t.id},a={screen_name:t.twitter,count:50};t.content?e.infoWindow.setContent(t.review):(e.infoWindow.setContent(e.preload),o=getJSON("https://widgets.ws/yelp/api.php",{method:"GET",apiquery:i}).then(function(o){return t.review=e.getYelpTemplate(t.name,t.diamonds,o[0].image_url,o[1].reviews[0].text,o[1].reviews[0].url),e.infoWindow.setContent(t.review),t.content=!0,Promise.resolve("Yelp API Success")}).catch(function(o){return t.content=null,e.infoWindow.setContent("Error retrieving Yelp data.<br>Please try again."),Promise.reject(new Error("Yelp API: "+o.status+" "+o.statusText))})),t.tweets?e.displayTweets(t.tweets):n=getJSON("https://widgets.ws/twitter/api.php",{method:"GET",apiquery:a}).then(function(o){return t.tweets=e.getTweets(t,o),e.displayTweets(t.tweets),Promise.resolve("Twitter API Success")}).catch(function(o){var n='<li><a href="'+("https://twitter.com/"+t.twitter)+'" target="_blank">Failed to load recent tweets for @';return n+=t.twitter+". Click here to view tweets on twitter.com.</a></li>",t.tweets=null,e.displayTweets(n),Promise.reject(new Error("Twitter API: "+o.status+" "+o.statusText))}),Promise.all([o,n]).then(function(e){window.console&&console.log("GET request results",e)}).catch(function(e){window.console&&console.error("GET request failed with",e)})},e.getYelpTemplate=function(e,t,o,n,i){for(var a=0,r=app.vm.getRatings(),s=r.length,l="",p="";a<s;a++)if(r[a].ratingValue===t){p=r[a].icon;break}return l="<h4>"+e+"</h4>",l+='<i class="diamonds small">'+p+"</i>",l+='<div class="gm-info-container">',l+='  <div class="gm-info-image"><img src="'+o+'" alt="'+e+'"></div>',l+='  <div class="gm-info-text">',l+='<img src="images/yelp_reviews.png" alt="Yelp Reviews"><br>',l+=n+' <a href="'+i+'">read more</a>',l+="  </div>",l+="</div>"},e.getTweets=function(e,t){var o="",n=t.length,i=0,a="",r="",s="",l="https://twitter.com/"+e.twitter+"/status/";for(n>5&&(n=5);i<n;i++)s=t[i].id_str,a=t[i].text,r=t[i].user.profile_image_url,o+='<li class="tweet">',o+='<a href="'+l+s+'" title="@'+e.twitter+'" target="_blank">',o+='<img src="'+r+'" alt="@'+e.twitter+'"> ',o+=a+"</a>",o+="</li>";return o},e.displayTweets=function(e){app.vm.showTicker(!0),app.vm.hotelTweets(e)}};